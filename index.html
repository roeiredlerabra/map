<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var CROSproxyURL = 'https://www.whateverorigin.org/get?url=';

      var args = '';
      if (typeof language != 'undefined') args += '&language=' + language;

      var bypass = function (googleAPIcomponentJS, googleAPIcomponentURL) {
          if (googleAPIcomponentURL.toString().indexOf("common.js") == -1) {
              googleAPIcomponentJS.src = googleAPIcomponentURL;
          } else {
              var removeFailureAlert = function(googleAPIcomponentURL) {
                  sendRequestThroughCROSproxy(googleAPIcomponentURL,(responseText)=>{
                      var script = document.createElement('script');
                      script.innerHTML = responseText.replace(new RegExp(/;if.*Failure.*\}/), ";");
                      document.head.appendChild(script);
                  });
              }
              googleAPIcomponentJS.innerHTML = '(' + removeFailureAlert.toString() + ')("' + googleAPIcomponentURL.toString() + '")';
          }
      }

      var createAndExecutePayload = function (googleAPIjs){
          var script = document.createElement('script');
          var appendChildToHeadJS = googleAPIjs.match(/(\w+)\.src=(_.*?);/);
          var googleAPIcomponentJS = appendChildToHeadJS[1];
          var googleAPIcomponentURL = appendChildToHeadJS[2];
          script.innerHTML = googleAPIjs.replace(appendChildToHeadJS[0], '(' + bypass.toString() + ')(' + googleAPIcomponentJS + ', ' + googleAPIcomponentURL + ');');
          document.head.appendChild(script);
      }

      sendRequestThroughCROSproxy('https://maps.googleapis.com/maps/api/js?key=:)&callback=initMap' + args, (googleAPIjs)=>{
          createAndExecutePayload(googleAPIjs);
      });

      function sendRequestThroughCROSproxy(url, callback){
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
              if (this.readyState == 4) {
                  if(this.status == 200){
                      if(callback) callback(JSON.parse(this.responseText).contents);
                  }else{
                      sendRequestThroughCROSproxy(url, callback);//retry
                  }
              }
          };
          xhttp.open("GET", CROSproxyURL + encodeURIComponent(url), true);
          xhttp.send();
      }

      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 31.8811398962883, lng: 34.959040145669334},
          zoom: 8
        });
      }
    </script>
    <script src="mapsJavaScriptAPI.js" async defer></script>
  </body>
</html>
